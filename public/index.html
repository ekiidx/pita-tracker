<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pita Tracker</title>
    <link href="assets/css/main.css" rel="stylesheet" />
</head>

<body class="bg-light">
    <div class="header card">
        <div class="logo">
            <a href="/"><img class="cat-logo" src="assets/img/cat-run.gif"></a>
            <h1>Pita Tracker 1.0</h1>
        </div>

        <div>
            <button onclick="openBloodModal()">+ Blood</button>
            <button onclick="openInsulinModal()">+ Insulin</button>
            <button onclick="openFoodModal()">+ Food</button>
        </div>
    </div>

    <!-- Blood Modal -->
    <div id="bloodModal" class="modal">
        <div class="modal-content">
            <form action="/blood" method="POST">
                <label for="date">Date</label>
                <input type="date" id="date" name="date" required>
                <label for="time">Time of Measurement</label>
                <input type="time" id="time" name="time" required>
                <label for="blood">Blood Glucose (mg/dL)</label>
                <input type="number" id="blood" name="blood" min="0" required>
                <label for="temp">Temperature (F)</label>
                <input type="number" id="temp" name="temp" min="0" required>
                <button type="submit">Submit</button>
                <button type="button" onclick="closeBloodModal()">Cancel</button>
            </form>
        </div>
    </div>
    <!-- Insulin Modal -->
    <div id="insulinModal" class="modal">
        <div class="modal-content">
            <form action="/insulin" method="POST">
                <label for="date">Date</label>
                <input type="date" id="date" name="date" required>
                <label for="time">Time of Measurement</label>
                <input type="time" id="time" name="time" required>
                <label for="insulin">Insulin Dose (u)</label>
                <input type="number" step="0.1" id="insulin" name="insulin">
                <button type="submit">Submit</button>
                <button type="button" onclick="closeInsulinModal()">Cancel</button>
            </form>
        </div>
    </div>
    <!-- Food Modal -->
    <div id="foodModal" class="modal">
        <div class="modal-content">
            <form action="/food" method="POST">
                <label for="date">Date</label>
                <input type="date" id="date" name="date" required>
                <label for="time">Time of Measurement</label>
                <input type="time" id="time" name="time" required>
                <label for="food">Food Amount (cups)</label>
                <input type="number" id="food" name="food" min="0" step=".1" required>
                <button type="submit">Submit</button>
                <button type="button" onclick="closeFoodModal()">Cancel</button>
            </form>
        </div>
    </div>

    <div class="main-content gap">
        <div class="entries bg-white">
            <div class="entries-header"> 
                <a href="/back"><img class="arrow-left" src="assets/img/arrow.png"></a>
                <h2>Today's Entries</h2>
                <img class="arrow-right" src="assets/img/arrow.png">
            </div>
        
            <table>
                <thead>
                    <tr>
                        <th style="padding-left: 1.5rem;">Type</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th style="padding-right: 1.5rem;">Amount</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="data-body"></tbody>
            </table>

            <div class="entries-footer">
               <div style="text-align: right;"> < > </div>
            </div>

        </div>

        <div class="graph-content card">
            <canvas id="bloodChartToday"></canvas>
        </div>
    </div>

    <script>
        // Tools
        const currentDate = new Date();
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth() + 1; // Add 1 because getMonth() is 0-indexed
        const day = currentDate.getDate();
        // const isoDate = currentDate.toISOString(); // Example using ISO string for a standard format (YYYY-MM-DDTHH:MM:SS.sssZ)
        const yyyyMmDd = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`; // Example for YYYY-MM-DD format

        window.onload = function() {
            fetch('/api/entries/' + yyyyMmDd)
                .then(res => res.json())
                .then(data => {
                    const tbody = document.getElementById('data-body');

                    data.forEach(row => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td style="padding-left: 1.5rem;">${row.source}</td>
                            <td>${row.date}</td>
                            <td style="min-width: 6rem;">${row.time}</td>
                            <td>${row.blood}</td>
                            <td style="padding-right: 1.5rem; padding-top: .5rem; padding-bottom: .5rem;"><?xml version="1.0"?><svg style="height: .875rem;" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><title/><path d="M16,10a3,3,0,1,0-3-3A3,3,0,0,0,16,10Z"/><path d="M16,19a3,3,0,1,0-3-3A3,3,0,0,0,16,19Z"/><path d="M16,28a3,3,0,1,0-3-3A3,3,0,0,0,16,28Z"/></svg></td>
                        `;
                        tbody.appendChild(tr);
                    });
                })
                .catch(err => {
                    console.error('Error fetching data:', err);
                });

            async function fetchChartData() {
                const res_blood = await fetch('/api/blood/' + yyyyMmDd + '');
                const res_insulin = await fetch('/api/insulin/' + yyyyMmDd + '');
                const res_food = await fetch('/api/food/' + yyyyMmDd + '');
                
                const bloodData = await res_blood.json();
                const insulinData = await res_insulin.json();
                const foodData = await res_food.json();

                // Convert backend time strings "HH:mm" to Date objects for chart.js. Date is irrelevant since we only display time axis.
                const bloodDataPoints = bloodData.map(({
                    time,
                    blood
                }) => {
                    const [hour, minute] = time.split(':').map(Number);
                    const date = new Date(2025, 5, 20, hour, minute); // months are 0-indexed in JS
                    return {
                        x: date,
                        y: blood
                    };
                });
                const insulinDataPoints = insulinData.map(({
                    time,
                    insulin
                }) => {
                    const [hour, minute] = time.split(':').map(Number);
                    const date = new Date(2025, 5, 20, hour, minute); // months are 0-indexed in JS
                    return {
                        x: date,
                        y: insulin
                    };
                });
                const foodDataPoints = foodData.map(({
                    time,
                    food
                }) => {
                    const [hour, minute] = time.split(':').map(Number);
                    const date = new Date(2025, 5, 20, hour, minute); // months are 0-indexed in JS
                    return {
                        x: date,
                        y: food
                    };
                });

                const ctxChartToday = document.getElementById('bloodChartToday').getContext('2d');
                new Chart(ctxChartToday, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Blood Glucose',
                            data: bloodDataPoints,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 225, 225, 0)',
                            fill: true,
                            tension: 0.4,
                            parsing: false // because we're using {x, y} objects directly
                        },
                        {
                            type: 'bar',
                            label: 'Insulin',
                            data: insulinDataPoints,
                            borderColor: 'rgba(154, 162, 235, 1)',
                            backgroundColor: 'rgba(154, 162, 235, 0.6)',
                            fill: true,
                            yAxisID: 'y1',
                        },
                        {
                            type: 'bar',
                            label: 'Food',
                            data: foodDataPoints,
                            borderColor: 'rgba(34, 139, 34, 1)',
                            backgroundColor: 'rgba(34, 139, 34, 0.6)',
                            fill: true,
                            yAxisID: 'y1',
                        }]
                    },
                    options: {
                        responsive: true,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        stacked: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'hour',
                                    displayFormats: {
                                        hour: 'h:mm'
                                    },
                                    tooltipFormat: 'h:mm'
                                },
                                title: {
                                    display: true,
                                    text: 'Time'
                                },
                                min: new Date(2025, 5, 20, 0, 0),
                                max: new Date(2025, 5, 20, 23, 59)
                            },
                            y: {
                                type: 'linear',
                                position: 'left',
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Blood Sugar (mg/dL)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Food (cups) / Insulin (u)'
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            }
                        },
                        barThickness: 10 
                    }
                });
            }
            fetchChartData();
        }

        function openBloodModal() {
            document.getElementById("bloodModal").style.display = "block";
        }
        function closeBloodModal() {
            document.getElementById("bloodModal").style.display = "none";
        }
        function openInsulinModal() {
            document.getElementById("insulinModal").style.display = "block";
        }
        function closeInsulinModal() {
            document.getElementById("insulinModal").style.display = "none";
        }
        function openFoodModal() {
            document.getElementById("foodModal").style.display = "block";
        }
        function closeFoodModal() {
            document.getElementById("foodModal").style.display = "none";
        }
    </script>
    <script src="assets/js/chartjs.min.js"></script>
    <script src="assets/js/chartjs-adapter-date-fns.min.js"></script>
</body>
</html>